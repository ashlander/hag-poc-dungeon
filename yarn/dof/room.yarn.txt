title: DofGameDungeonRoom
---
    <<set $dofPlayer.dofX to $dofPlayer.dofNextX>>
    <<set $dofPlayer.dofY to $dofPlayer.dofNextY>>
    <<set $dofPlayer.dofOrientation to $dofPlayer.dofNextOrientation>>
    <<set $dofRoom to "Room x{$dofPlayer.dofX} y{$dofPlayer.dofY}">>
    <<set $dofRoom.$dofX to $dofPlayer.dofX>>
    <<set $dofRoom.$dofY to $dofPlayer.dofY>>

//// DEBUG
//<<box>>
//Room info:
//    room        = {$dofRoom}
//    run         = player {$dofPlayer.$dofRunNum}/{$dofRoom.$dofRunNum} room
//<<endbox>>


    //DEBUG: You are in the room {$dofRoom}

    // generate room if player was upstairs, some of the rooms will be unchanged
    <<if $dofPlayer.$dofRunNum > $dofRoom.$dofRunNum>>
        // generate room
        <<set $DofFunctionGenerateRoom_room to $dofRoom>>
        <<hagCallNode name="DofFunctionGenerateRoom">>

        // set run number, so it will be unchanged until dungeon exit
        <<set $dofRoom.$dofRunNum to $dofPlayer.$dofRunNum>>
    <<endif>>

//    // check if visited room, output something funny
//    <<if $dofRoom.$dofVisited>>
//        You have a strong feeling that you has been here already.
//    <<else>>
//        // TODO random room description
//    <<endif>>
//
//    <<if $dofPlayer.dofX is 0 and $dofPlayer.dofY is 0>>
//        You are near entrance spot. You have {$dofPlayer.dofGold} coins in your pocket.
//        [[Let me out!|DofGameDungeonEntrance]] // TODO price to pay
//    <<endif>>

    <<set $dofRoom.$dofVisited to true>>

    // show room map
    <<hagHistoryClean>>

//// DEBUG
//<<box>>
//Room info:
//    room        = {$dofRoom}
//    run         = player {$dofPlayer.$dofRunNum}/{$dofRoom.$dofRunNum} room
//<<endbox>>
//
//
//// DEBUG
//<<box>>
//Chest dice:
//    chance      = positive {$dofRandomRoomChest.$dofPositive}/{$dofRandomRoomChest.$dofNegative} negative
//    boost       = positive {$dofRandomRoomChest.$dofPositiveBoost}/{$dofRandomRoomChest.$dofNegativeBoost} negative
//    current     = positive {$dofRandomRoomChest.$dofPositiveNum}/{$dofRandomRoomChest.$dofNegativeNum} negative
//    roll        = {$dofRandomRoomChest.$dofRoll}
//    positive    = {$dofRandomRoomChest.$dofRollPositive}
//<<endbox>>


    <<set $DofFunctionAddMapRoom_room to $dofRoom>>
    <<hagCallNode name="DofFunctionAddMapRoom">>
    <<hagHighlightBlocksShow columns=4 center=true>>
    <<set $dofResult to result("")>>

    // process result
    <<if $dofResult is "TopDoor">> // forward
        // orientation preserved
        <<hagCallNode name="DofGameDungeonCorridor">>
    <<elseif $dofResult is "LeftDoor">> // left
        <<if $dofPlayer.dofOrientation is "YPositive">>
            <<set $dofPlayer.dofNextOrientation to "XNegative">>
        <<elseif $dofPlayer.dofOrientation is "XNegative">>
            <<set $dofPlayer.dofNextOrientation to "YNegative">>
        <<elseif $dofPlayer.dofOrientation is "YNegative">>
            <<set $dofPlayer.dofNextOrientation to "XPositive">>
        <<elseif $dofPlayer.dofOrientation is "XPositive">>
            <<set $dofPlayer.dofNextOrientation to "YPositive">>
        <<else>>
            You seems to stuck here. This is internal program failure. Please, report it to the support team and provide a save file.
            // TODO [[Save environment for support team|Game.Save]]
            // TODO Recover option
        <<endif>>
        <<hagCallNode name="DofGameDungeonCorridor">>
    <<elseif $dofResult is "RightDoor">> // right
        <<if $dofPlayer.dofOrientation is "YPositive">>
            <<set $dofPlayer.dofNextOrientation to "XPositive">>
        <<elseif $dofPlayer.dofOrientation is "XPositive">>
            <<set $dofPlayer.dofNextOrientation to "YNegative">>
        <<elseif $dofPlayer.dofOrientation is "YNegative">>
            <<set $dofPlayer.dofNextOrientation to "XNegative">>
        <<elseif $dofPlayer.dofOrientation is "XNegative">>
            <<set $dofPlayer.dofNextOrientation to "YPositive">>
        <<else>>
            You seems to stuck here. This is internal program failure. Please, report it to the support team and provide a save file.
            // TODO [[Save environment for support team|Game.Save]]
            // TODO Recover option
        <<endif>>
        <<hagCallNode name="DofGameDungeonCorridor">>
    <<elseif $dofResult is "BottomDoor">> // back
        <<if $dofPlayer.dofOrientation is "YPositive">>
            <<set $dofPlayer.dofNextOrientation to "YNegative">>
        <<elseif $dofPlayer.dofOrientation is "YNegative">>
            <<set $dofPlayer.dofNextOrientation to "YPositive">>
        <<elseif $dofPlayer.dofOrientation is "XPositive">>
            <<set $dofPlayer.dofNextOrientation to "XNegative">>
        <<elseif $dofPlayer.dofOrientation is "XNegative">>
            <<set $dofPlayer.dofNextOrientation to "XPositive">>
        <<else>>
            You seems to stuck here. This is internal program failure. Please, report it to the support team and provide a save file.
            // TODO [[Save environment for support team|Game.Save]]
            // TODO Recover option
        <<endif>>
        <<hagCallNode name="DofGameDungeonCorridor">>
    <<elseif $dofResult is "Player">> // back
        <<hagHistoryClean>>

        // show equipment title
        <<hagCallNode name="DofFunctionAddPlayerEquipmentTitle">>
        <<hagHighlightBlocksShow>>

        // show equipment items
        <<hagCallNode name="DofFunctionAddPlayerEquipment">>
        <<hagHighlightBlocksShow>>

        // show inventory title
        <<hagCallNode name="DofFunctionAddPlayerInventoryTitle">>
        <<hagHighlightBlocksShow>>

        // show inventory items
        <<hagCallNode name="DofFunctionAddPlayerInventory">>
        <<hagHighlightBlocksShow>>

        [[Back|DofGameDungeonRoom]]
    <<else>>
        [[DofGameDungeonRoom]]
    <<endif>>

===
